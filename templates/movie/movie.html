{% extends 'layout/base.html' %}
{% load static %}
{% load filter %}

{% block meta %}
{% endblock %}
{% block og:title %}movie{% endblock %}
{% block og:description %}description{% endblock %}
{% block title %}movie{% endblock %}

{% block content %}
<main>
    <h1>Hello Movie!</h1>
    {% include 'movie/movie_toc.html' %}
    {% if user.is_authenticated %}
        {% include 'movie/movie_form.html' %}
    {% endif %}
    <div id="movies">
    {% if movieList %}
        {% for movie in movieList %}
        <div id="{{movie.id}}">
            id={{movie.id}}
            <img src="{{movie.thumbnail.url}}" alt="{{movie.title}}">
            <div>{{movie.format}}</div>
            <div>{{movie.title}}</div>
            <div>{{movie.title_en}}</div>
            <div>{{movie.brand}}&nbsp;{{movie.location}}</div>
            <div>{{movie.date|date:'Y.m.d'}}({{movie.weekday|weekday}})</div>
            <div>
                <a href="{{movie.poster.url}}" target="_blank">원본</a>
                {% if user.is_authenticated %}
                <button onClick="select('{{movie.id}}')">수정</button>
                <button onClick="delete_movie('{{movie.id}}')">삭제</button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% endif %}
    </div>
</main>
<script>
    {% if user.is_authenticated %}
    function insert(){
        document.getElementsByName("id")[0].value = "";
    }
    function search_movie(){
        const url = "{% url 'movie:search'%}";
        const options = {
            method: "POST",
            mode: "same-origin",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({
                movieNm: document.getElementById("movieNm").value,
            }),
        }
        fetch(url, options)
        .then((response) => response.json())
        .then(data => {
            if(data.status){
                if(data.data.length > 0){
                    let movieList = document.getElementById('movieList');
                    movieList.innerHTML = '';
                    data.data.forEach(el => {
                        movieList.innerHTML += `
                            <div id="${el.movieCd}">
                                <button type="button" onClick="get_name('${el.movieCd}')">선택</button>
                                <input type="text" value="${el.movieNm}"/>
                                <input type="text" value="${el.movieNmEn}"/>
                            </div>`
                    });
                }else{
                    alert('없어');
                }
            }else{
                alert(data.message)
            }
        })
        .catch((error) => console.log("error:", error));
    }
    function get_name(movieCd){
        const children = document.getElementById(movieCd).children;
        document.getElementById("{{form.title.id_for_label}}").value = children[1].value?children[1].value:'None';
        document.getElementById("{{form.title_en.id_for_label}}").value = children[2].value?children[2].value:'None';
    }

    const form = document.getElementById("form");
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const url = "{% url 'movie:insert'%}";
        const payload = new FormData(form);
        if(payload.get("id") === ""){
            if(payload.get("poster").size == 0 && payload.get("poster").name == ''){
                alert("포스터 업로드 하쇼잉");
                return false;
            }
        }
        const options = {
            method: "POST",
            mode: "same-origin",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: payload,
        }
        fetch(url, options)
        .then(response => response.json())
        .then(data => {
            if(data.status){
                const movie = data.data;
                const date = data.data.date.replaceAll("-",".");
                const weekday = ["월","화","수","목","금","토","일"];
                const htmlString = `
                <div id="${movie.id}">
                    <img src="{% get_media_prefix %}${movie.thumbnail}" alt="${movie.title}">
                    <div>${movie.format}</div>
                    <div>${movie.title}</div>
                    <div>${movie.title_en}</div>
                    <div>${movie.brand}&nbsp;${movie.location}</div>
                    <div>${date}(${weekday[movie.weekday]})</div>
                    <div>
                        <a href="{% get_media_prefix %}${movie.poster}" target="_blank">원본</a>
                        <button onClick="select('${movie.id}')">수정</button>
                        <button onClick="delete_movie('${movie.id}')">삭제</button>
                    </div>
                </div>
                `;
                if(payload.get("id") === ""){
                    document.getElementById('movies').insertAdjacentHTML('afterbegin',htmlString);
                }else{
                    document.getElementById(movie.id).insertAdjacentHTML('afterend',htmlString);
                    document.getElementById(movie.id).remove();
                }
                alert(data.message);
            }else{
                let mess = "";
                for(key in data.data){
                    mess += key+": "+data.data[key]+"\n";
                }
                alert(data.message+"\n"+mess);
            }
        })
        .catch((error) => console.log("error:", error));
    });

    function select(id) {
        const url = "{% url 'movie:select' %}";
        const options = {
            method: "POST",
            mode: "same-origin",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                movie_id: id,
            }),
        }
        fetch(url, options)
        .then(response => response.json())
        .then(data => {
            if(data.status){
                for(key in data.data){
                    const el = document.getElementsByName(key)[0];
                    if(el !== undefined){
                        if(el.type =='radio'){
                            const radio = document.querySelectorAll("input[name='"+key+"']");
                            radio.forEach(r => {
                                if (r.value === data.data[key]) {
                                    r.checked = true;
                                }
                            });
                        }else if(el.type == "file"){
                            //afterend
                        }else{
                            el.value = data.data[key];
                        }
                    }
                }
            }else{
                alert(data.message);
            }
        })
        .catch((error) => console.log("error:", error));
    }
    function delete_movie(id) {
        const url = "{% url 'movie:delete' %}";
        const options = {
            method: "POST",
            mode: "same-origin",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                movie_id: id,
            }),
        }
        fetch(url, options)
        .then(response => response.json())
        .then(data => {
            if(data.status){
                document.getElementById(id).remove();
                alert(data.message);
            }else{
                alert(data.message);
            }
        })
        .catch((error) => console.log("error:", error));
    }
    {% endif %}
    //현이에게 js 관리 어케 하는지 물어보기
</script>
{% endblock %}